<div id="back_link">&laquo;&nbsp;<a href="javascript:load_content('docs')">Back to Documentation</a></div>

<h1>Building an Ubuntu image on a RHEL host</h1>
<p>
This recipe describes how to build an Ubuntu image using Singularity on a RHEL compatible host. In order to do this, you will need to first install the 'debootstrap' package onto your host. Then, you will create a definition file that will describe how to build your Ubuntu image. Finally, you will build the image using the Singularity commands 'create' and 'bootstrap'.
</p>

<h4>Preperation</h4>
<p>
  This recipe assumes that you have already installed Singularity on your computer. If you have not, follow the instructions here to <a href="javascript:load_content('install')">install</a>.
  
  After Singularity is installed on your computer, you will need to install the 'debootstrap' package. The 'debootstrap' package is a tool that will allow you to create Debian-based distributions such as Ubuntu. In order to install 'debootstrap', you will also need to install 'epel-release'. 
</p>

<pre>
# This installs epel-release
$ sudo yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  
# This install debootstrap
$ sudo yum install debootstrap
</pre>

<h4>Creating the Definition File</h4>
<p>
  You will need to create a definition file to describe how to build your Ubuntu image. Definition files are plaintext files that contain Singularity keywords. By using certain Singularity keywords, you can specifiy how you want your image to be built. The extension '.def' is recommended for user clarity. Below is a definition file for a minimal Ubuntu image:
</p>

<pre>
DistType "debian"
MirrorURL "http://us.archive.ubuntu.com/ubuntu/"
OSVersion "trusty"
  
Setup
Bootstrap
  
Cleanup
</pre>

<p>
  The following keywords were used in this definition file:
  <ul>
  <li>
    <b>DistType</b>: DistType specifies the distribution type of your intended operating system. Because we are trying to build an Ubuntu image, the type "debian" was chosen. 
  </li>
  <li>
    <b>MirrorURL</b>: The MirrorURL specifies the download link for your intended operating system. The Ubuntu archive website is a great mirror link to use if you are building an Ubuntu image. 
  </li>
  <li>
    <b>OSVersion</b>: The OSVersion is used to specify which release of a Debian-based distribution you are using. In this example we chose "trusty" to specifiy that we wanted to build an Ubuntu 14.04 (Trusty Tahr) image. 
  </li>
  <li>
    <b>Setup</b>: Setup creates some of the base files and components for an OS and is highly recommended to be included in your definition file. 
  </li>
  <li>
    <b>Bootstrap</b>: Bootstrap will call apt-get to install the appropriate package to build your OS. 
  </li>
  <li>
    <b>Cleanup</b>: Cleanup remove temporary files from the installation. 
  </li>
  </ul>
</p>

<p>
  While this definition file is enough to create a working Ubuntu image, you may want increased customization of your image. There are several Singularity keywords that allow the user to do things such as install packages or files. Some of these keywords are used in the example below:
</p>

<pre>
DistType "debian"
MirrorURL "http://us.archive.ubuntu.com/ubuntu/"
OSVersion "trusty"
  
Setup 
Bootstrap
  
InstallPkgs python
InstallPkgs wget
RunCmd wget https://bootstrap.pypa.io/get-pip.py
RunCmd python get-pip.py

Cleanup
</pre>

<p>
  Before going over exactly what image this definition file specifies, the remaining Singularity keywords should be introduced.
  <ul>
  <li>
    <b>InstallPkgs</b>: InstallPkgs allows you to install any packages that you want on your newly created image.
  </li>
  <li>
    <b>InstallFile</b>: InstallFile allows you to install files from your computer to the image.
  </li>
  <li>
    <b>RunCmd</b>: RunCmd allows you to run a command from within the new image during the installation.
  </li>
  <li>
    <b>RunScript</b>: RunScript adds a new line to the runscript invoked by the Singularity subcommand 'run'. See the <a href="javascript:load_content('cli_run')">run</a> page for more information.
  </li>
  </ul>
</p>

<p>
  Now that you are familiar with all of the Singularity keywords, we can take a closer look at the example above. As with the previous example, an Ubuntu image is created with the specified DistType, MirrorURL, and OSVersion. However, after Setup and Bootstrap, we used the InstallPkgs keyword to install 'python' and 'wget'. Then we used the RunCmd keyword to first download the pip installation wheel, and then to install pip. Thus, we have created a definition file that will install 'python' and 'pip' onto the new image. 
</p>

<h4>Creating your image</h4>
<p>
  Once you have created your definition file, you will be ready to actually create your image. You will do this by utilizing the Singularity 'create' and 'bootstrap' subcommands. The process for doing this can be seen below (note that we have saved our definition file as "ubuntu.def"):

<pre>
# First we will create an empty image container called ubuntu.img
$ sudo singularity create ubuntu.img
  
# Next we will bootstrap the image with the operating system specified in our definition file
$ sudo singularity bootstrap ubuntu.img ubuntu.def
Creating a sparse image with a maximum size of 1024MiB...
INFO   : Using given image size of 1024
Formatting image (/sbin/mkfs.ext3)
Done. Image can be found at: doc.img
W: Cannot check Release signature; keyring file not available /usr/share/keyrings/ubuntu-archive-keyring.gpg
I: Retrieving Release 
I: Retrieving Packages 
I: Validating Packages 
I: Resolving dependencies of required packages...
I: Resolving dependencies of base packages...
I: Found additional base dependencies: gcc-4.8-base gnupg gpgv libapt-pkg4.12 libreadline6 libstdc++6 libusb-0.1-4 readline-common ubuntu-keyring 
I: Checking component main on http://us.archive.ubuntu.com/ubuntu...
I: Retrieving adduser 3.113+nmu3ubuntu3
I: Validating adduser 3.113+nmu3ubuntu3
I: Retrieving apt 1.0.1ubuntu2
I: Validating apt 1.0.1ubuntu2
</pre>
snip...
<pre>
Downloading pip-8.1.2-py2.py3-none-any.whl (1.2MB)
  100% |################################| 1.2MB 1.1MB/s 
Collecting setuptools
Downloading setuptools-24.0.2-py2.py3-none-any.whl (441kB)
  100% |################################| 450kB 2.7MB/s 
Collecting wheel
Downloading wheel-0.29.0-py2.py3-none-any.whl (66kB)
  100% |################################| 71kB 9.9MB/s 
Installing collected packages: pip, setuptools, wheel
Successfully installed pip-8.1.2 setuptools-24.0.2 wheel-0.29.0
</pre>
At this point, you have successfully created an Ubuntu image with 'python' and 'pip' on your RHEL computer. 
</p>
